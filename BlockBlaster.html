<!DOCTYPE html>
<html>
	<head>
	<title>BlockBlaster</title>
	</head>
	<body onload="reset()">
		<canvas style="border: 1px dotted"id="canvas" width="800" height="600" onclick="canvasClick()">
		<script>
			//Globals Variables
			//-----------------
			var fps = 30;
			var canvasWidth = 800;
			var canvasHeight = 600;
			var canvas = document.getElementById("canvas");
			var ctx = canvas.getContext("2d");
			var bgColor = "#323232"

			var ready;
			var enemyScore;
			var renderTimer;
			var difficultyTimer;
			var spawnTimer;
			var spawntime;
			var gameTime;
			var difficulty;
			var score;
			var gameOver;
			var entities = [];
			var player;

			//Global Functions
			//----------------

			//initialize
			function init(){

				ready = false;

				renderTimer = setInterval(render,1/fps * 100);
				difficultyTimer = setInterval(increaseDifficulty,2000);
				spawnTimer = setInterval(spawnEnemy,spawntime);

				//Spawn player
				player = new Player();
				player.position.set(canvasWidth/2,canvasHeight-player.size);
				player.render();
				entities.push(player);

				canvas.addEventListener('mousemove', function(evt) {
					var mousePos = getMousePos(canvas, evt);
					if (player) player.position.x = mousePos.x;
				}, false);
			}

			function reset(){
				ready = true;
				enemyScore = 0;
				gameTime = 0;
				ready = false;
				difficulty = 1;
				score = 0;
				spawntime = 2000;
				gameOver = false;
				entities = [];
				player = null;

				clearInterval(renderTimer);
				clearInterval(difficultyTimer);
				clearInterval(spawnTimer);

				drawBG();
				drawScore();

				ctx.fillStyle = "#FFFFFF";
				ctx.font = "72px sans-serif";
				ctx.fillText("READY?",canvasWidth/2 - 150,canvasHeight/2);
				ready = true;
			}

			function updateEntities(){
				entities.forEach(function(e){
					if (e.position.y > canvasHeight + 20){
						if (e.name == "Enemy"){
							score -= 10;
							enemyScore += 1;
						}
						removeEntity(e);
					}
					e.update(1/fps);
				})
			}

			function drawBG(){
				ctx.fillStyle = bgColor;
				ctx.fillRect(0,0,canvasWidth,canvasHeight);
			}

			function drawScore(){
				ctx.fillStyle = "#CCFF99";
				ctx.font = "24px sans-serif";
				ctx.fillText("Score: " + score,10,24);

				var enemyScoreString = "";
				for (var i = 0; i < enemyScore; i++){
					enemyScoreString += "X";
				}
				ctx.fillStyle = "#FF6666";
				ctx.fillText(enemyScoreString,canvasWidth - 50,24);

				ctx.font = "16px sans-serif";
				ctx.fillText("Difficulty: " + difficulty,canvasWidth/2 - 50,24);

			}

			function render(){
				if (gameOver || ready) return;
				drawBG();
				updateEntities();
				entities.forEach(function(e){e.render();});
				drawScore();
				gameTime += 1/fps;
				if (enemyScore >= 3){
					gameOver = true;
					ctx.fillStyle = "#FFFFFF";
					ctx.font = "72px sans-serif";
					ctx.fillText("GAME OVER",canvasWidth/2 - 220,canvasHeight/2);
				}
			}

			function getMousePos(canvas, evt) {
						var rect = canvas.getBoundingClientRect();
				return new Vector2(evt.clientX - rect.left,
									evt.clientY - rect.top)
			}

			function canvasClick(){

				if (gameOver){
					reset();
					return;
				}

				if (ready){
					init();
					return;
				}

				var bullet = new Bullet();
				bullet.position.set(player.position.x,player.position.y - player.size/2 - bullet.size /2);
				bullet.velocity.y = -30;
				entities.push(bullet);
				if (score > 0) score -= 1;
			}

			function increaseDifficulty(){
				difficulty += 1;
				spawntime -= 3;
				clearInterval(spawnTimer);
				spawnTimer = setInterval(spawnEnemy,spawntime);
			}

			function death(entity){
				if (entity.name == "Enemy") {
					var particleCount = Math.floor((Math.random() * 10) + 5);
					for (var i = 0; i < particleCount; i++){
						var p = new Particle();
						p.color = entity.color;
						p.size = Math.floor((Math.random() * entity.size/particleCount * 2) + 5);
						p.position.set(entity.position.x,entity.position.y);
						entities.push(p);
					}
					score += 5;
				}
				removeEntity(entity);
			}

			function removeEntity(entity){
				var idx = entities.indexOf(entity);
				if (idx > -1) entities.splice(idx,1);
			}

			function overlaps(entityA,entityB){
				var sa = entityA.size/2;
				var x1a = entityA.position.x - sa;
				var x2a = entityA.position.x + sa;
				var y1a = entityA.position.y - sa;
				var y2a = entityA.position.y + sa;

				var sb = entityB.size/2;
				var x1b = entityB.position.x - sb;
				var x2b = entityB.position.x + sb;
				var y1b = entityB.position.y - sb;
				var y2b = entityB.position.y + sb;

				return (x1a < x2b && x2a > x1b && y1a < y2b && y2a > y1b);
			}

			//Spawns new enemy
			function spawnEnemy(){
				var e = new Enemy();
				var px = Math.floor((Math.random() * canvasWidth));
				var py = -e.size;
				var v = difficulty;
				var a = Math.floor((Math.random() * (v + 15)) + v);
				var f = Math.floor((Math.random() * (v + 15)) + v);
				e.position.set(px,py);

				var r = Math.random();
				if (r > .5){
					straightDownMotion(e,v);
				}
				else if (r > .3){
					sineMotion(e,a,f,v);
				}
				else if (r > .1){
					triangularMotion(e,a,f,v);
				}
				else{
					sawtoothMotion(e,a,f,v);
				}

				entities.push(e);
			}

			//Straight down motion
			function straightDownMotion(entity,speed){
				entity.update = function(deltatime){
					this.velocity.x = 0;
					this.velocity.y = speed;
					Entity.prototype.update.call(this,deltatime);
				}
			}
			//Define sin wave motion
			function sineMotion(entity,amplitude,freq,speed){
				entity.update = function(deltatime){
					this.velocity.x = amplitude * Math.cos(this.position.y/freq);
					this.velocity.y = speed;
					Entity.prototype.update.call(this,deltatime);
				}
			}
			//Define saw tooth motion (sorta)
			function sawtoothMotion(entity, amplitude,freq,speed){
				entity.update = function(deltatime){
					this.velocity.x = ((-2*amplitude)/Math.PI)*Math.atan(1/Math.tan(this.position.y / freq));
					this.velocity.y = speed;
					Entity.prototype.update.call(this,deltatime);
				}
			}
			//Define triangular motion ()
			function triangularMotion(entity, amplitude,freq,speed){
				entity.update = function(deltatime){
					this.velocity.x = ((2*amplitude)/Math.PI)*Math.asin(Math.sin(this.position.y / freq));
					this.velocity.y = speed;
					Entity.prototype.update.call(this,deltatime);
				}
			}

			// Classes
			//----------

			//Vector2
			var Vector2 = function(x1,y1){
				this.x = x1;
				this.y = y1;
			}
			Vector2.prototype.set = function(a,b){
				this.x = a;
				this.y = b;
			}

			//Entity (Base class)
			var Entity = function(){
				this.name = "Entity";
				this.size = 25;
				this.position = new Vector2(0,0);
				this.velocity = new Vector2(0,0);
				this.color = "#FFFFFF";
			}
			Entity.prototype.sayName = function(){
				console.log(this.name);
			}
			Entity.prototype.update = function(deltaTime){
				this.position.x += this.velocity.x * deltaTime;
				this.position.y += this.velocity.y * deltaTime;

				//Keep in bounds
				if (this.position.x - this.size < 0) {this.position.x = this.size;}
				if (this.position.x + this.size > canvasWidth) {this.position.x = canvasWidth - this.size;}
			}
			Entity.prototype.render = function(){
				ctx.fillStyle = this.color;
				ctx.fillRect(this.position.x,this.position.y,this.size,this.size);
			}

			//Enemy Entity
			var Enemy = function(){
				Entity.call(this);
				this.name = "Enemy";
				this.size = Math.floor((Math.random() * 50)+20);
				this.color = "#DB4C4C"
			}
			Enemy.prototype = Object.create(Entity.prototype);
			Enemy.prototype.constructor = Entity;


			//Player Entity
			var Player = function(){
				Entity.call(this);
				this.name = "Player";
				this.color = "#4747FF"
			}
			Player.prototype = Object.create(Entity.prototype);
			Player.prototype.constructor = Entity;

			//Particle Entity
			var Particle = function(){
				Entity.call(this);
				this.name = "Particle";
				this.size = 10;
				this.time = 0;
				this.maxTime = 5;
				this.velocity.x = Math.floor((Math.random() * 20) - 10);
				this.velocity.y = Math.floor((Math.random() * 20) - 10);
			}
			Particle.prototype = Object.create(Entity.prototype);
			Particle.prototype.constructor = Entity;
			Particle.prototype.update = function(deltatime){
				Entity.prototype.update.call(this,deltatime);
				this.time += deltatime;
				if (this.time >= this.maxTime) removeEntity(this);
			}

			//Bullet Entity
			var Bullet = function(){
				Entity.call(this);
				this.name = "Bullet";
				this.size = 10;
				this.time = 0;
				this.particlesDelay = .1;
			}
			Bullet.prototype = Object.create(Entity.prototype);
			Bullet.prototype.constructor = Entity;
			Bullet.prototype.update = function(deltatime){
				Entity.prototype.update.call(this,deltatime);

				var me = this;
				entities.forEach(function(e){
					if (e !== me && e.name != "Particle"){
						if (overlaps(me,e)){
							death(e);
							removeEntity(me);
						}
					}
				})

				if (this.position.y < 0) removeEntity(this);

				this.time += deltatime;
				if (this.time >= this.particlesDelay){
					this.time = 0;
					var p = new Particle();
					p.size = 3;
					if (Math.random() > .7)	p.color = "#fb8320";
					else p.color = "#fb8320";
					p.velocity.x /=2;
					p.position.x = this.position.x + this.size /2;
					p.position.y = this.position.y;
					p.maxTime = 2;
					entities.push(p);
				}
			}
		</script>
	</body>
</html>
